<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>QR Livin' Generator - Mandiri</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #f4f6f9;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        main {
            flex: 1;
        }
        
        .card-print {
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            margin: auto;
            border-radius: 20px;
            background: linear-gradient(to bottom right, #e0f2ff, #fff);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            background: url('https://raw.githubusercontent.com/ekstrah/motif-mandiri/main/mandiri-wave.svg') no-repeat bottom right/300px;
        }
        
        .livin-tag {
            font-size: 24px;
            font-weight: bold;
            color: #007dfe;
        }
        
        .qr-box {
            border: 4px solid #007dfe;
            padding: 15px;
            border-radius: 20px;
            background: white;
            display: inline-block;
            margin: 20px 0;
        }
        
        .btn-download {
            display: block;
            margin: 10px auto;
        }
        
        footer {
            background: transparent;
            padding: 1rem 0;
            text-align: center;
            font-size: .9rem;
            color: #6c757d;
        }
        
        .qr-icon {
            display: inline-block;
            padding: 12px;
            background-color: rgba(0, 85, 165, 0.1);
            border-radius: 12px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%,
            100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #007dfe;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .share-buttons button {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .link-container {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .link-text {
            word-break: break-all;
            font-size: 14px;
            color: #495057;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 350px;
            display: none;
        }
        
        .copy-fallback {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            max-width: 90%;
            width: 400px;
        }
        
        .copy-fallback input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .copy-fallback button {
            margin: 5px;
        }
        
        .copied {
            background-color: #4CAF50 !important;
            color: white !important;
        }
        
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .toast {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success {
            background-color: #4CAF50;
        }
        
        .toast.error {
            background-color: #f44336;
        }
        
        .toast.info {
            background-color: #2196F3;
        }
        /* Tambahan style untuk validasi */
        
        .is-invalid {
            border-color: #dc3545 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .invalid-feedback {
            display: none;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
        
        @media (max-width: 768px) {
            h2 {
                font-size: 1.8rem !important;
            }
            .qr-icon {
                width: 40px;
                height: 40px;
            }
            .sync-status {
                right: 10px;
                left: 10px;
                max-width: none;
            }
            .copy-fallback {
                width: 90%;
            }
            .toast-container {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>

<body>
    <!-- Status Sinkronisasi -->
    <div id="syncStatus" class="alert alert-info sync-status">
        <span class="spinner-border spinner-border-sm" role="status"></span>
        <span id="syncStatusText">Menyinkronkan data...</span>
    </div>

    <!-- Fallback UI untuk Copy -->
    <div id="copyFallback" class="copy-fallback">
        <h5>Salin Tautan</h5>
        <p>Gunakan tombol salin di bawah atau salin secara manual:</p>
        <input type="text" id="fallbackCopyInput" readonly="">
        <div class="text-end mt-3">
            <button class="btn btn-secondary" onclick="document.getElementById('copyFallback').style.display='none'">Tutup</button>
            <button class="btn btn-primary" onclick="fallbackCopyManual()">Salin</button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <main>
        <div class="container py-5">
            <div id="HeaderTitle" class="text-center mb-5">
                <div class="qr-icon mb-3">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="8" height="8" rx="1" fill="#0d6efd"></rect>
                        <rect x="3" y="13" width="8" height="8" rx="1" fill="#0d6efd"></rect>
                        <rect x="13" y="3" width="8" height="8" rx="1" fill="#0d6efd"></rect>
                        <rect x="13" y="13" width="3" height="3" rx="0.5" fill="#00A0E3"></rect>
                        <rect x="18" y="13" width="3" height="3" rx="0.5" fill="#00A0E3"></rect>
                        <rect x="13" y="18" width="3" height="3" rx="0.5" fill="#00A0E3"></rect>
                        <rect x="18" y="18" width="3" height="3" rx="0.5" fill="#00A0E3"></rect>
                    </svg>
                </div>
                <h2 class="fw-bold mb-2" style="color: #0055A5; font-size: 2rem;">QR Generator GMM</h2>
                <p class="text-muted" style="font-size: 1.1rem;"><span style="color: #0055A5; font-weight: 500;">Livin
                        by' Bank Mandiri</span></p>
                <p class="mt-3" style="color: #6c757d; font-size: 1rem;">Isi data ‚Üí Generate QR ‚Üí Download/Share</p>
            </div>

            <!-- Form Mode Direct -->
            <div id="formDirect" class="card shadow-sm rounded-4 p-4 mb-5 mx-auto" style="max-width:800px;">
                <form id="qr-form-direct" class="row g-4">
                    <div class="col-md-6">
                        <label for="nip" class="form-label fw-semibold">Kode MGM</label>
                        <input id="nip" class="form-control form-control-lg" style="font-size: 14px !important;" type="text" required="" placeholder="Masukkan Kode MGM (contoh: MGMXXXXX)">
                        <div id="nip-invalid" class="invalid-feedback" style="display: none;">
                            Kode MGM harus diawali dengan "MGM"
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label for="kodeCabang" class="form-label fw-semibold">Kode Cabang</label>
                        <input id="kodeCabang" class="form-control form-control-lg" style="font-size: 14px !important;" type="text" placeholder="Masukkan Kode Cabang (opsional, 5 digit angka)">
                        <div id="kodeCabang-invalid" class="invalid-feedback" style="display: none;">
                            Kode Cabang harus berupa 5 digit angka
                        </div>
                    </div>

                    <div class="col-12 text-center">
                        <button class="btn btn-primary btn-lg mt-3 px-5" type="submit">üîç Generate QR</button>
                    </div>
                </form>
            </div>

            <!-- QR Result Area -->
            <div id="capture-area" class="card-print text-center" style="display:none;">
                <div class="livin-tag">Livin' by Mandiri</div>
                <p class="text-muted mb-1">Scan QR code ini untuk download aplikasi Livin'</p>
                <div id="qr-area" class="qr-box"></div>
                <div id="qr-spinner" class="mt-3" style="display:none;">
                    <div class="spinner"></div>
                    <p class="text-muted mt-2 mb-0">Membuat QR...</p>
                </div>

                <div class="link-container">
                    <p class="link-text" id="generated-link"></p>
                </div>

                <div class="share-buttons">
                    <button id="btnCopyLink" class="btn btn-outline-primary btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z">
                            </path>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z">
                            </path>
                        </svg>
                        Copy Link
                    </button>

                    <button id="btnShare" class="btn btn-outline-info btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-share" viewBox="0 0 16 16">
                            <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z">
                            </path>
                        </svg>
                        Share
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-muted">QR ini akan mengarahkan ke Play Store / App Store</small>
                </div>

                <!-- Tombol Buat QR Baru -->
                <div class="mt-4 d-flex justify-content-center gap-2 flex-wrap">
                    <button id="btnNewQR" class="btn btn-outline-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        Buat QR Baru
    </button>
                    <button id="btnDownloadQROnly" onclick="downloadQROnly()" class="btn btn-outline-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
        Download QR
    </button>
                </div>

                <hr class="my-4">
                <p class="text-muted small mb-0">Bank Mandiri terdaftar dan diawasi oleh OJK <br>¬© 2025 PT Bank Mandiri (Persero) Tbk.</p>
            </div>

            <div class="text-center mt-3">
                <!-- Tombol Download Ultra HD telah dihapus -->

            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const logoBase64 = ""; // isi dengan base64 logo jika ada
        let generatedUrl = "";
        let qrImageDataUrl = ""; // Menyimpan data URL gambar QR

        // Konfigurasi Google Apps Script
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzdNSL8EIp5y9diBESC1wy4Htl-4M1qsO3u1c-R8codHHk3-ZnypGYPTPfSyL9VEaWZ/exec';

        // Fungsi untuk menampilkan toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            const container = document.getElementById('toastContainer');
            container.appendChild(toast);

            // Tampilkan toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Hapus setelah 3 detik
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Fungsi untuk validasi input
        function validateInputs() {
            const nipInput = document.getElementById("nip");
            const kodeCabangInput = document.getElementById("kodeCabang");
            let isValid = true;

            // Validasi Kode MGM harus diawali dengan "MGM"
            const nipValue = nipInput.value.trim();
            if (!nipValue.startsWith("MGM")) {
                nipInput.classList.add("is-invalid");
                document.getElementById("nip-invalid").style.display = "block";
                isValid = false;
            } else {
                nipInput.classList.remove("is-invalid");
                document.getElementById("nip-invalid").style.display = "none";
            }

            // Validasi Kode Cabang (jika diisi) harus numerik dan 5 digit
            const kodeCabangValue = kodeCabangInput.value.trim();
            if (kodeCabangValue !== "") {
                const isNumeric = /^\d+$/.test(kodeCabangValue);
                if (!isNumeric || kodeCabangValue.length !== 5) {
                    kodeCabangInput.classList.add("is-invalid");
                    document.getElementById("kodeCabang-invalid").style.display = "block";
                    isValid = false;
                } else {
                    kodeCabangInput.classList.remove("is-invalid");
                    document.getElementById("kodeCabang-invalid").style.display = "none";
                }
            } else {
                kodeCabangInput.classList.remove("is-invalid");
                document.getElementById("kodeCabang-invalid").style.display = "none";
            }

            return isValid;
        }

        // Event listener untuk validasi real-time
        document.getElementById("nip").addEventListener("input", function() {
            const nipValue = this.value.trim();
            if (nipValue.startsWith("MGM") || nipValue === "") {
                this.classList.remove("is-invalid");
                document.getElementById("nip-invalid").style.display = "none";
            } else {
                this.classList.add("is-invalid");
                document.getElementById("nip-invalid").style.display = "block";
            }
        });

        document.getElementById("kodeCabang").addEventListener("input", function() {
            const kodeCabangValue = this.value.trim();
            if (kodeCabangValue === "") {
                this.classList.remove("is-invalid");
                document.getElementById("kodeCabang-invalid").style.display = "none";
                return;
            }

            const isNumeric = /^\d+$/.test(kodeCabangValue);
            if (isNumeric && kodeCabangValue.length === 5) {
                this.classList.remove("is-invalid");
                document.getElementById("kodeCabang-invalid").style.display = "none";
            } else {
                this.classList.add("is-invalid");
                document.getElementById("kodeCabang-invalid").style.display = "block";
            }
        });

        // Fungsi untuk mengkonversi data URL ke Blob
        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const uInt8Array = new Uint8Array(raw.length);

            for (let i = 0; i < raw.length; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], {
                type: contentType
            });
        }

        // Fungsi untuk berbagi gambar QR melalui WhatsApp
        function shareViaWhatsAppWithImage(text, imageDataUrl) {
            // WhatsApp tidak mendukung sharing gambar langsung melalui URL web
            // Jadi kita akan membuka WhatsApp dengan teks dan meminta pengguna menambahkan gambar manual
            const message = `${text}: ${generatedUrl}\n\nSilakan tambahkan gambar QR code yang telah didownload.`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        // Class untuk mengelola clipboard dengan fallback
        class ClipboardManager {
            constructor() {
                this.supported = this.checkClipboardSupport();
            }

            checkClipboardSupport() {
                // Selalu gunakan fallback method untuk menghindari permissions policy issues
                return false;
            }

            async copyText(text) {
                // Selalu gunakan fallback method untuk menghindari permissions policy issues
                return this.fallbackCopy(text);
            }

            fallbackCopy(text) {
                try {
                    // Method 1: execCommand (bekerja di sebagian besar browser)
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.top = '0';
                    textArea.style.left = '0';
                    textArea.style.opacity = '0';

                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);

                    if (successful) {
                        return {
                            success: true,
                            method: 'execCommand'
                        };
                    }

                    // Method 2: Selection API fallback
                    return this.selectionCopy(text);

                } catch (error) {
                    console.error('Fallback copy failed:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            selectionCopy(text) {
                try {
                    const div = document.createElement('div');
                    div.textContent = text;
                    div.style.whiteSpace = 'pre';
                    div.style.position = 'fixed';
                    div.style.top = '0';
                    div.style.left = '0';
                    div.style.opacity = '0';

                    document.body.appendChild(div);

                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(div);
                    selection.removeAllRanges();
                    selection.addRange(range);

                    const successful = document.execCommand('copy');
                    selection.removeAllRanges();
                    document.body.removeChild(div);

                    return {
                        success: successful,
                        method: 'selection'
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }
        }

        // Class untuk mengelola sharing dengan fallback
        class ShareManager {
            constructor() {
                this.supported = !!navigator.share;
                this.supportedFiles = !!navigator.share && !!navigator.canShare;
                this.embedded = this.checkIfEmbedded();
            }

            checkIfEmbedded() {
                try {
                    return window.self !== window.top;
                } catch (e) {
                    return true;
                }
            }

            async share(data) {
                // Untuk embedded context, selalu gunakan fallback
                if (this.embedded) {
                    return this.embeddedShare(data);
                }

                // Coba native share jika tersedia
                if (this.supported) {
                    try {
                        await navigator.share(data);
                        return {
                            success: true,
                            method: 'native'
                        };
                    } catch (error) {
                        if (error.name === 'NotAllowedError') {
                            return this.fallbackShare(data);
                        }
                        return {
                            success: false,
                            error: error.message
                        };
                    }
                } else {
                    // Fallback untuk browser yang tidak mendukung
                    return this.fallbackShare(data);
                }
            }

            embeddedShare(data) {
                // Untuk embedded context, gunakan WhatsApp sharing
                this.shareViaWhatsApp(data);
                return {
                    success: true,
                    method: 'whatsapp'
                };
            }

            fallbackShare(data) {
                // Fallback ke WhatsApp
                this.shareViaWhatsApp(data);
                return {
                    success: true,
                    method: 'whatsapp'
                };
            }

            shareViaWhatsApp(data) {
                const url = data.url || window.location.href;
                const text = data.text || 'Check this QR code from Livin by Mandiri';
                const whatsappText = `${text}: ${url}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(whatsappText)}`, '_blank');
            }

            async shareWithImage(data, imageDataUrl) {
                // Di embedded context, tidak mungkin mengirim gambar melalui Web Share API
                // Jadi kita selalu gunakan fallback ke WhatsApp tanpa gambar
                if (this.embedded) {
                    this.shareViaWhatsApp(data);
                    return {
                        success: true,
                        method: 'whatsapp'
                    };
                }

                // Untuk non-embedded context, coba share dengan gambar
                if (!imageDataUrl) {
                    return this.share(data);
                }

                try {
                    // Konversi data URL ke Blob
                    const blob = dataURLToBlob(imageDataUrl);
                    const fileName = `QR_Livin_${Date.now()}.png`;

                    // Buat file dari Blob
                    const file = new File([blob], fileName, {
                        type: 'image/png'
                    });

                    // Siapkan data share dengan file
                    const shareData = {
                        title: data.title || 'QR Livin by Mandiri',
                        text: data.text || 'Cobain pakai Livin\' by Mandiri, yuk! Ajak temen lain, nanti kamu juga bisa dapat banyak reward.',
                        url: data.url || generatedUrl,
                        files: [file]
                    };

                    // Coba share dengan file
                    if (this.supportedFiles && navigator.canShare && navigator.canShare({
                            files: shareData.files
                        })) {
                        await navigator.share(shareData);
                        return {
                            success: true,
                            method: 'native-with-image'
                        };
                    } else {
                        // Fallback ke share tanpa gambar
                        console.log('Sharing files not supported, falling back to text sharing');
                        const fallbackData = {...shareData
                        };
                        delete fallbackData.files;
                        return this.share(fallbackData);
                    }
                } catch (error) {
                    console.error('Error sharing with image:', error);
                    // Fallback ke share tanpa gambar
                    return this.share(data);
                }
            }
        }

        // Inisialisasi manager
        const clipboardManager = new ClipboardManager();
        const shareManager = new ShareManager();

        // Form submission untuk mode direct
        document.getElementById("qr-form-direct").addEventListener("submit", function(e) {
            e.preventDefault();

            // Validasi input sebelum melanjutkan
            if (!validateInputs()) {
                return;
            }

            const nip = document.getElementById("nip").value.trim();
            const kodeCabang = document.getElementById("kodeCabang").value.trim();

            if (nip.length === 0) return alert("Kode MGM tidak boleh kosong");

            // Kode cabang sekarang opsional, jika kosong akan diubah menjadi "null"
            generateQRDirect(nip, kodeCabang);
        });

        // Generate QR code untuk mode direct
        function generateQRDirect(nip, kodeCabang) {
            // Jika kodeCabang kosong, ubah menjadi "null"
            const cabangValue = kodeCabang.length === 0 ? "null" : kodeCabang;

            // Create URL dengan pola yang diminta
            generatedUrl = `https://bmri.id/reflivin?af_adset=${nip}&deep_link_sub1=${cabangValue}&deep_link_sub2=${nip}`;

            // Tampilkan URL yang dihasilkan
            document.getElementById("generated-link").textContent = generatedUrl;

            // Kirim data ke Google Sheets
            sendDataToGoogleSheets(nip, cabangValue);

            // Generate QR code
            generateQRCode(generatedUrl, nip, cabangValue);
        }

        // Fungsi untuk mengirim data ke Google Sheets
        async function sendDataToGoogleSheets(nip, kodeCabang) {
            const syncStatus = document.getElementById("syncStatus");
            const syncStatusText = document.getElementById("syncStatusText");

            try {
                syncStatus.style.display = "block";
                syncStatus.className = "alert alert-info sync-status";
                syncStatusText.textContent = "Menyinkronkan data...";

                const response = await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify({
                        nip: nip,
                        kodeCabang: kodeCabang,
                        timestamp: new Date().toISOString(),
                        url: generatedUrl
                    }),
                    headers: {
                        "Content-Type": "application/json"
                    }
                });

                syncStatus.className = "alert alert-success sync-status";
                syncStatusText.textContent = "Data berhasil disinkronkan ";

                // Sembunyikan status setelah 3 detik
                setTimeout(() => {
                    syncStatus.style.display = "none";
                }, 3000);

            } catch (error) {
                console.error("Error mengirim data:", error);
                syncStatus.className = "alert alert-danger sync-status";
                syncStatusText.textContent = "Gagal menyinkronkan data. Silakan coba lagi.";

                // Sembunyikan status setelah 5 detik
                setTimeout(() => {
                    syncStatus.style.display = "none";
                }, 5000);
            }
        }

        // Fungsi utama untuk membuat QR code
        function generateQRCode(url, nip, kodeCabang) {
            const qrDiv = document.getElementById("qr-area");
            const qrSpinner = document.getElementById("qr-spinner");
            const captureArea = document.getElementById("capture-area");
            const formDirect = document.getElementById("formDirect");
            const HeaderTitle = document.getElementById("HeaderTitle");
            const btnQROnly = document.getElementById("btnDownloadQROnly");

            // Sembunyikan form dan tampilkan capture area
            HeaderTitle.style.display = "none";
            formDirect.style.display = "none";
            captureArea.style.display = "block";

            qrDiv.innerHTML = "";
            qrSpinner.style.display = "block";
            btnQROnly.style.display = "none";

            try {
                // Hapus QR sebelumnya jika ada
                while (qrDiv.firstChild) {
                    qrDiv.removeChild(qrDiv.firstChild);
                }

                // Buat QR code baru
                new QRCode(qrDiv, {
                    text: url,
                    width: 1000,
                    height: 1000,
                    colorDark: "#000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Tambahkan logo setelah QR dihasilkan
                setTimeout(() => {
                    const canvas = qrDiv.querySelector("canvas");
                    if (!canvas) {
                        console.error("Canvas QR tidak terbentuk");
                        qrSpinner.style.display = "none";
                        return;
                    }

                    const ctx = canvas.getContext("2d");
                    const imgLogo = new Image();

                    imgLogo.onload = function() {
                        try {
                            const maxLogoRatio = 0.25;
                            const logoSize = canvas.width * maxLogoRatio;
                            const ar = imgLogo.width / imgLogo.height;
                            const lw = ar > 1 ? logoSize : logoSize * ar;
                            const lh = ar > 1 ? logoSize / ar : logoSize;
                            const x = (canvas.width - lw) / 2;
                            const y = (canvas.height - lh) / 2;
                            const pad = 8;

                            // Tambahkan latar belakang putih untuk logo
                            ctx.fillStyle = "#fff";
                            ctx.beginPath();
                            ctx.roundRect(x - pad, y - pad, lw + pad * 2, lh + pad * 2, 16);
                            ctx.fill();

                            // Gambar logo
                            ctx.drawImage(imgLogo, x, y, lw, lh);

                            // Konversi ke gambar
                            const img = document.createElement("img");
                            qrImageDataUrl = canvas.toDataURL("image/png"); // Simpan data URL
                            img.src = qrImageDataUrl;
                            img.style.width = "250px";
                            img.style.height = "250px";
                            img.alt = "QR Code";

                            qrDiv.innerHTML = "";
                            qrDiv.appendChild(img);

                            qrSpinner.style.display = "none";
                            btnQROnly.style.display = "block";
                        } catch (e) {
                            console.error("Error saat menambahkan logo:", e);
                            qrSpinner.style.display = "none";
                        }
                    };

                    imgLogo.onerror = function() {
                        console.error("Logo gagal dimuat");
                        // Tetap tampilkan QR tanpa logo jika logo gagal dimuat
                        const img = document.createElement("img");
                        qrImageDataUrl = canvas.toDataURL("image/png"); // Simpan data URL
                        img.src = qrImageDataUrl;
                        img.style.width = "250px";
                        img.style.height = "250px";

                        qrDiv.innerHTML = "";
                        qrDiv.appendChild(img);

                        qrSpinner.style.display = "none";
                        btnQROnly.style.display = "block";
                    };

                    // Jika tidak ada logo, tetap tampilkan QR
                    if (!logoBase64 || logoBase64.trim() === "") {
                        const img = document.createElement("img");
                        qrImageDataUrl = canvas.toDataURL("image/png"); // Simpan data URL
                        img.src = qrImageDataUrl;
                        img.style.width = "250px";
                        img.style.height = "250px";

                        qrDiv.innerHTML = "";
                        qrDiv.appendChild(img);

                        qrSpinner.style.display = "none";
                        btnQROnly.style.display = "block";
                    } else {
                        imgLogo.src = logoBase64;
                    }
                }, 600);
            } catch (e) {
                console.error("Error saat generate QR:", e);
                qrSpinner.style.display = "none";
                alert("Terjadi kesalahan saat membuat QR code. Silakan coba lagi.");
            }
        }

        // Download QR only
        function downloadQROnly() {
            const qrImg = document.querySelector("#qr-area img");
            const nip = document.getElementById("nip").value.trim();
            const kodeCabang = document.getElementById("kodeCabang").value.trim() || "null";
            const fileName = `QR_Only_${nip}_${kodeCabang}.png`;

            if (!qrImg) return alert("QR belum digenerate");

            // Tampilkan loading pada tombol
            const btn = document.getElementById("btnDownloadQROnly");
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            btn.disabled = true;

            try {
                const link = document.createElement("a");
                link.href = qrImg.src;
                link.download = fileName;
                link.click();
            } catch (e) {
                console.error("Error downloading QR only:", e);
                alert("Gagal mendownload QR. Silakan coba lagi.");
            } finally {
                // Kembalikan tampilan tombol
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Fungsi untuk menampilkan fallback UI copy
        function showCopyFallback(text) {
            const fallback = document.getElementById('copyFallback');
            const input = document.getElementById('fallbackCopyInput');
            input.value = text;
            fallback.style.display = 'block';
        }

        // Fungsi untuk copy manual dari fallback UI
        function fallbackCopyManual() {
            const input = document.getElementById('fallbackCopyInput');
            input.select();
            try {
                document.execCommand('copy');
                showToast('Tautan berhasil disalin!', 'success');
                document.getElementById('copyFallback').style.display = 'none';
            } catch (err) {
                showToast('Gagal menyalin. Silakan salin secara manual.', 'error');
            }
        }

        // Copy link to clipboard dengan fallback
        document.getElementById("btnCopyLink").addEventListener("click", async function() {
            if (!generatedUrl) {
                showToast('Belum ada link yang digenerate', 'error');
                return;
            }

            const result = await clipboardManager.copyText(generatedUrl);

            if (result.success) {
                const originalText = this.innerHTML;
                this.innerHTML = '‚úì Link Copied!';
                this.classList.add('copied');
                showToast('Tautan berhasil disalin!', 'success');

                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('copied');
                }, 2000);
            } else {
                // Tampilkan fallback UI
                showCopyFallback(generatedUrl);
            }
        });

        // Share link dengan gambar QR
        document.getElementById("btnShare").addEventListener("click", async function() {
            if (!generatedUrl) {
                showToast('Belum ada QR yang digenerate', 'error');
                return;
            }

            const btn = this;
            const originalText = btn.innerHTML;

            // Tampilkan indikator loading
            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const shareData = {
                    title: 'QR Livin by Mandiri',
                    text: 'Cobain pakai Livin\' by Mandiri, yuk! Ajak temen lain, nanti kamu juga bisa dapat banyak reward. Download di sini',
                    url: generatedUrl
                };

                let result;

                if (qrImageDataUrl) {
                    // Coba share dengan gambar
                    result = await shareManager.shareWithImage(shareData, qrImageDataUrl);
                } else {
                    // Fallback ke share tanpa gambar
                    result = await shareManager.share(shareData);
                }

                if (!result.success) {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error sharing:', error);

                // Fallback ke WhatsApp
                if (qrImageDataUrl) {
                    // Untuk WhatsApp, kita tidak bisa langsung share gambar
                    // Jadi kita arahkan pengguna untuk menambahkan gambar manual
                    shareViaWhatsAppWithImage(
                        'Cobain pakai Livin\' by Mandiri, yuk! Ajak temen lain, nanti kamu juga bisa dapat banyak reward. Download di sini',
                        qrImageDataUrl
                    );
                } else {
                    shareManager.shareViaWhatsApp(shareData);
                }
            } finally {
                // Kembalikan tampilan tombol ke semula
                btn.classList.remove('btn-loading');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Fungsi untuk membuat QR baru (refresh halaman)
        document.getElementById("btnNewQR").addEventListener("click", function() {
            location.reload();
        });
    </script>
</body>

</html>